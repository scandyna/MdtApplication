###########################################
# Deploy Conan - OS independant (use Linux)
###########################################

deploy_conan_CommandLineArguments:
  extends: .deploy_conan_base
  image: registry.gitlab.com/scandyna/docker-images-ubuntu/ubuntu-18.04-xserver-build-tools:latest
  script:
    - conan create packaging/conan/CommandLineArguments scandyna/testing
      --profile:build linux_gcc8_x86_64 --profile:host linux_gcc8_x86_64 -s build_type=Debug
      --test-folder None
    - conan user --password "${CI_JOB_TOKEN}" --remote scandyna ci_user
    - conan upload MdtCommandLineArguments/* --remote scandyna --all -c


###########################################
# Deploy Conan
###########################################


.deploy_conan_base_SANDBOX:
  stage: build
  before_script:
    - !reference [.setup_conan, script]
    - echo profile build "${CONAN_PROFILE_OS}_${CONAN_PROFILE_COMPILER}_x86_64"
    - echo profile host "${CONAN_PROFILE_OS}_${CONAN_PROFILE_COMPILER}_${CONAN_PROFILE_ARCH}_qt_widgets_modules"
    - echo build_type $BUILD_TYPE
    - echo Mdt$COMPONENT:shared=$BUILD_SHARED_LIBS 


.deploy_conan_matrix:
  extends: .deploy_conan_base_SANDBOX
  needs: ["deploy_conan_CommandLineArguments"]
  script:
    - conan create packaging/conan/$COMPONENT scandyna/testing
      --profile:build "${CONAN_PROFILE_OS}_${CONAN_PROFILE_COMPILER}_x86_64"
      --profile:host "${CONAN_PROFILE_OS}_${CONAN_PROFILE_COMPILER}_${CONAN_PROFILE_ARCH}_qt_widgets_modules"
      -s build_type=$BUILD_TYPE
      -o Mdt$COMPONENT:shared=$BUILD_SHARED_LIBS --test-folder None
    - conan user --password "${CI_JOB_TOKEN}" --remote scandyna ci_user
    #- conan upload $COMPONENT/* --remote scandyna --all -c


deploy_conan_Linux:
  extends: .deploy_conan_matrix
  image: registry.gitlab.com/scandyna/docker-images-ubuntu/ubuntu-18.04-xserver-build-tools:latest
  variables:
    CONAN_PROFILE_OS: linux
  parallel:
    matrix:
      - COMPONENT:
          - ConsoleApplication
          - CoreApplicationForNonQtUsage
          - GuiApplicationForNonQtUsage
        CONAN_PROFILE_COMPILER:
          - gcc8
        CONAN_PROFILE_ARCH:
          - x86_64
        BUILD_TYPE:
          - Debug
          - Release
        BUILD_SHARED_LIBS:
          - "True"
          - "False"
